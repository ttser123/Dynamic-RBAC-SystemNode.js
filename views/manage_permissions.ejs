<% 
    // ตัวแปรที่ต้องส่งมาจาก app.js
    // allPermissions: รายการสิทธิ์ทั้งหมด (จากตาราง permissions)
    // currentSettings: Object ที่เก็บว่า Role ไหนมีสิทธิ์อะไรบ้าง (จากตาราง role_permissions)
    
    const roles = ['staff', 'member']; // ไม่ให้แก้สิทธิ์ Admin
%>

<%- include('partials/layout', { 
    title: 'Admin - ตั้งค่าสิทธิ์', 
    user: user, 
    body: `
        <h2 class="mb-4"><i class="fas fa-shield-alt"></i> ตั้งค่าสิทธิ์การเข้าถึง (Permissions)</h2>
        <p>กำหนดว่า Role ใด สามารถเข้าถึงส่วนใดของระบบได้บ้าง (สิทธิ์ของ Admin จะถูกกำหนดไว้ถาวร)</p>
        
        ${(messages.success && messages.success.length > 0) ? '<div class="alert alert-success">' + messages.success + '</div>' : ''}

        <form action="/admin/manage-permissions/update" method="POST">
            <table class="table table-bordered table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>สิทธิ์การเข้าถึง (Permission)</th>
                        
                        ${roles.map(role => `<th class="text-center">${role.toUpperCase()}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${allPermissions.map(perm => `
                        <tr>
                            <td>
                                <strong>${perm.permission_key}</strong>
                                <br>
                                <small class="text-muted">${perm.description}</small>
                            </td>
                            
                            ${roles.map(role => {
                                // ตรวจสอบว่า Role นี้มีสิทธิ์นี้อยู่หรือไม่ (จาก currentSettings)
                                const hasPermission = currentSettings[role] && currentSettings[role].includes(perm.id);
                                
                                return `
                                <td class="text-center align-middle">
                                    <input type="checkbox" 
                                           name="permissions[${role}][]" 
                                           value="${perm.id}" 
                                           ${hasPermission ? 'checked' : ''}
                                           style="transform: scale(1.5);">
                                </td>
                                `;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <button type="submit" class="btn btn-primary mt-1">
                <i class="fas fa-save"></i> บันทึกการเปลี่ยนแปลงสิทธิ์
            </button>
        </form>
    `, 
    script: '' 
}) %>