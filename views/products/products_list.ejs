<% 
    const body_content = `
        <h2 class="mb-4"><i class="fas fa-box"></i> เพิ่มสินค้า (Test n8n)</h2>
        
        <form id="productForm">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <p class="h5 mb-0">กรอกข้อมูลสินค้า (สามารถเพิ่มหลายรายการได้)</p>
                </div>
                
                <div class="card-body" id="product-list-container">
                    <div class="form-row product-row mb-2">
                        <div class="col-md-5">
                            <label>ชื่อสินค้า</label>
                            <input type="text" class="form-control" name="productName[]" required>
                        </div>
                        <div class="col-md-5">
                            <label>ราคา</label>
                            <input type="number" class="form-control" name="price[]" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-block remove-product-row" style="display: none;">
                                <i class="fas fa-trash"></i> ลบ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-success" id="add-product-row">
                        <i class="fas fa-plus"></i> เพิ่มแถว
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-paper-plane"></i> ส่งข้อมูลทั้งหมด
                    </button>
                </div>
            </div>
        </form>
    `;

    // (สคริปต์ jQuery/Fetch เดิมของคุณ ใช้งานได้เลย)
    const script_content = `
        <script>
            function updateRemoveButtons() {
                const rows = $('#product-list-container .product-row');
                rows.each(function(index, row) {
                    const removeBtn = $(row).find('.remove-product-row');
                    if (index === 0) {
                        removeBtn.hide(); // ซ่อนปุ่มลบแถวแรก
                    } else {
                        removeBtn.show();
                    }
                });
            }

            $('#add-product-row').on('click', function() {
                const firstRow = $('#product-list-container .product-row').first();
                const newRow = firstRow.clone();
                newRow.find('input').val(''); // ล้างค่า
                $('#product-list-container').append(newRow);
                updateRemoveButtons();
            });

            $('#product-list-container').on('click', '.remove-product-row', function() {
                $(this).closest('.product-row').remove();
                updateRemoveButtons();
            });

            $('#productForm').on('submit', async function(e) {
                e.preventDefault();
                const btn = $(this).find('#submitBtn');
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> กำลังส่ง...');
                
                const formData = new FormData(this);
                const data = {
                    productName: formData.getAll('productName[]'),
                    price: formData.getAll('price[]')
                };

                try {
                    const response = await fetch('/products/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (!response.ok) { throw new Error(result.message); }

                    Toast.fire({ icon: 'success', title: result.message });
                    
                    // ล้างฟอร์ม (เหลือแถวแรกแถวเดียว)
                    $('#product-list-container').children('.product-row:not(:first)').remove();
                    $(this)[0].reset();
                    updateRemoveButtons();

                } catch (error) {
                    Toast.fire({ icon: 'error', title: error.message });
                } finally {
                    btn.prop('disabled', false).html('<i class="fas fa-paper-plane"></i> ส่งข้อมูลทั้งหมด');
                }
            });

            updateRemoveButtons(); // เรียกครั้งแรกตอนโหลด
        </script>
    `;
%>

<%- include('../partials/layout', { 
    title: 'เพิ่มสินค้า (n8n)', 
    user: user, 
    body: body_content, 
    script: script_content 
}) %>