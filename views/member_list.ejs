<% 
    // *******************************************************************
    // 1. สร้างตัวแปรตรวจสอบสิทธิ์ (ส่วนนี้ถูกต้อง)
    // *******************************************************************
    const hasViewDetailsPerm = user.role === 'admin' || user.permissions.includes('view_member_details');
    const hasEditProfilePerm = user.role === 'admin' || user.permissions.includes('edit_member_profile');
    const hasResetPasswordPerm = user.role === 'admin' || user.permissions.includes('reset_member_password');
    const hasCreateMemberPerm = user.role === 'admin' || user.permissions.includes('create_member');

    const canTakeAction = hasViewDetailsPerm || hasEditProfilePerm || hasResetPasswordPerm;


    // *******************************************************************
    // 2. สร้างแถวตาราง Member (แก้ไขส่วนที่ขาดหาย)
    // *******************************************************************
    const memberTableRows = members.map(member => {
        
        let actionButtons = ''; // เริ่มด้วยค่าว่าง

        // 1. ปุ่มดูรายละเอียด
        if (hasViewDetailsPerm) {
            actionButtons += `
                <a href="/member/details/${member.id}" class="btn btn-sm btn-secondary">
                    <i class="fas fa-eye"></i> ดู
                </a>
            `;
        }

        // 2. ปุ่มแก้ไข
        if (hasEditProfilePerm) {
            actionButtons += `
                <a href="/member/edit/${member.id}" class="btn btn-sm btn-info">
                    <i class="fas fa-edit"></i> แก้ไข
                </a>
            `;
        }

        // 3. ปุ่มรีเซ็ตรหัสผ่าน
        if (hasResetPasswordPerm) {
            actionButtons += `
                <form action="/member/reset-password/${member.id}" method="POST" class="d-inline" onsubmit="return confirm('ยืนยันการรีเซ็ตรหัสผ่านสำหรับ ${member.username}?');">
                    <button type="submit" class="btn btn-sm btn-warning">
                        <i class="fas fa-key"></i> รีเซ็ต
                    </button>
                </form>
            `;
        }

        return `
            <tr>
                <td>${member.id}</td>
                <td>${member.username}</td>
                <td>${member.first_name} ${member.last_name}</td>
                
                ${canTakeAction ? `<td>${actionButtons}</td>` : ''}
            </tr>
        `;
    }).join('');
    
    // *******************************************************************
    // 3. เนื้อหาหลักของ Body (ส่วนนี้ถูกต้อง)
    // *******************************************************************
    const body_content = `
        <h2 class="mb-4"><i class="fas fa-users"></i> รายการ Member ทั้งหมด</h2>
        
        ${(messages.success && messages.success.length > 0) ? '<div class="alert alert-success">' + messages.success + '</div>' : ''}
        ${(messages.error && messages.error.length > 0) ? '<div class="alert alert-danger">' + messages.error + '</div>' : ''}

        <div class="row mb-3">
            <div class="col-md-4">
                ${hasCreateMemberPerm ? `
                    <button class="btn btn-primary" data-toggle="modal" data-target="#addMemberModal">
                        <i class="fas fa-plus"></i> เพิ่ม Member
                    </button>
                ` : ''}
            </div>
            <div class="col-md-8">
                <form action="/member-list" method="GET" class="form-inline float-right">
                    <input type="text" name="search" class="form-control mr-sm-2" placeholder="ค้นหา Member" value="${searchQuery || ''}">
                    <button type="submit" class="btn btn-outline-secondary"><i class="fas fa-search"></i> ค้นหา</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>ชื่อ - นามสกุล</th>
                        ${canTakeAction ? '<th>ดำเนินการ (Actions)</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${members.length === 0 ? `<tr><td colspan="${canTakeAction ? 4 : 3}" class="text-center">ไม่พบข้อมูล Member</td></tr>` : memberTableRows}
                </tbody>
            </table>
        </div>
    `;
%>

<%- include('partials/layout', { 
    title: 'รายการ Member', 
    user: user, 
    body: body_content, 
    script: '' 
}) %>


<% if (hasCreateMemberPerm) { %>
<div class="modal fade" id="addMemberModal" tabindex="-1" role="dialog" aria-labelledby="addMemberModalLabel" aria-hidden="true">
  </div>
<% } %>